<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulation Chirurgie Réfractive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --background: #f7faff;
      --card-bg: #fafdff;
      --text: #111a23;
      --label: #4A707A;
      --input-bg: #fff;
      --input-border: #c2ced9;
      --input-focus: #9ec8e9;
      --input-readonly: #f4f7fb;
      --green: #29d658;
      --orange: #ffd700;
      --red: #ff3558;
      --blue-accent: #a5c8ee;
      --card-shadow: 0 2px 16px rgba(70, 90, 120, 0.06);
      --radius: 16px;
      --main-width: 1020px;
      --input-width: 85px;
      --icon-size: 1rem;
    }
    html, body {
      background: var(--background);
      margin: 0; padding: 0;
      font-family: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
      color: var(--text);
      font-size: 18px;
    }
    h1 {
      text-align: center;
      color: var(--label);
      font-size: 2.1rem;
      font-weight: 700;
      margin: 2rem 0 1.3rem 0;
      letter-spacing: 0.04em;
    }
    .container {
      max-width: var(--main-width);
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      padding: 2.3rem 1rem 2rem 1rem;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    .section {
      margin-bottom: 2.2rem;
    }
    .section-title {
      font-size: 1.17rem;
      font-weight: 600;
      color: var(--blue-accent);
      margin-bottom: 0.7rem;
      letter-spacing: 0.03em;
    }
    .main-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 2rem;
      min-width: 320px;
    }
    .main-table th, .main-table td {
      padding: 0.5em 0.2em;
      text-align: center;
      vertical-align: middle;
      font-size: 1.04rem;
    }
    .main-table th {
      color: var(--label);
      font-weight: 600;
      background: none;
      font-size: 1.08rem;
      border-bottom: 2.5px solid #e2e9f0;
    }
    .main-table td:first-child, .main-table th:first-child {
      text-align: right;
      font-weight: 500;
      color: var(--label);
      width: 175px;
      background: none;
      border-right: 1.5px solid #e2e9f0;
    }
    .main-table input[type="number"],
    .main-table input[type="text"] {
      width: var(--input-width);
      background: var(--input-bg);
      color: var(--text);
      border: 2.5px solid var(--input-border);
      border-radius: 8px;
      font-size: 1.03em;
      padding: 7px 8px;
      outline: none;
      box-sizing: border-box;
      transition: border .2s, box-shadow .2s;
      text-align: center;
      margin-right: 0.6em;
    }
    .main-table input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px #dbefff8c;
    }
    .main-table input[readonly] {
      background: var(--input-readonly);
      color: #8fa5b3;
    }
    .main-table .icon {
      font-size: var(--icon-size);
      vertical-align: middle;
    }
    .colored-green + .icon { color: var(--green); }
    .colored-orange + .icon { color: var(--orange); }
    .colored-red + .icon { color: var(--red); }
    .colored-empty + .icon { color: #b3bdc7; }

    .slider-wrap {
      display: flex;
      align-items: center;
      gap: 0.5em;
      width: 130px;
      margin: 0 auto;
    }
    .slider-wrap input[type="range"] {
      flex: 1;
      accent-color: var(--blue-accent);
      min-width: 60px;
    }
    .slider-wrap span {
      font-size: 0.98rem;
      color: var(--label);
      width: 2.1em;
      text-align: left;
      margin-left: 0.4em;
    }
    /* Lasik/PKR sous-tableau */
    .sub-simu-table {
      width: 100%;
      margin: 0;
      border-collapse: collapse;
    }
    .sub-simu-table th, .sub-simu-table td {
      padding: 0.45em 0.2em;
      text-align: center;
      font-size: 0.99rem;
    }
    .sub-simu-table th {
      color: var(--label);
      border-bottom: 1.5px solid #e2e9f0;
      background: none;
    }
    .sub-simu-table td:first-child, .sub-simu-table th:first-child {
      text-align: right;
      color: var(--label);
      background: none;
      width: 170px;
      font-size: 0.97rem;
    }
    .pkr-warning {
      display: block;
      margin: 0.4em 0 0 0;
      color: var(--red);
      font-weight: 600;
      font-size: 0.97rem;
      letter-spacing: 0.01em;
      text-align: center;
      min-height: 1.7em;
    }

    .anisometropie-block {
      max-width: 500px;
      margin: 2.1rem auto 0 auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      padding: 1.1rem 2rem;
      display: flex; flex-direction: column; align-items: center;
    }
    .anisometropie-label {
      color: var(--label);
      font-size: 1.08rem;
      font-weight: 500;
      margin-bottom: 0.5em;
    }
    .anisometropie-input {
      width: 90px;
      text-align: center;
      font-size: 1.13rem;
    }
    .anisometropie-block .icon {
      font-size: 1.2rem;
      vertical-align: middle;
      margin-left: 0.6em;
    }
    .buttons {
      text-align: center;
      margin: 2.1rem 0 0 0;
    }
    button {
      background: var(--blue-accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 30px;
      font-size: 1.11rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 14px rgba(100, 140, 190, 0.08);
      transition: background 0.18s;
      letter-spacing: 0.02em;
    }
    button:hover { background: #4674a8; }

    /* Responsive : tout passe à une seule colonne sur mobile */
    @media (max-width: 800px) {
      .main-table, .main-table th, .main-table td,
      .sub-simu-table, .sub-simu-table th, .sub-simu-table td {
        font-size: 1.01rem;
      }
      .main-table th, .main-table td,
      .sub-simu-table th, .sub-simu-table td {
        padding: 0.38em 0.12em;
      }
      .slider-wrap { min-width: 105px; }
    }
    @media (max-width: 600px) {
      .container {
        padding: 1.2rem 0.2rem;
      }
      .main-table, .sub-simu-table {
        min-width: unset;
        font-size: 0.99rem;
      }
      .main-table th, .main-table td,
      .sub-simu-table th, .sub-simu-table td {
        padding: 0.23em 0.08em;
      }
      .main-table th:first-child, .main-table td:first-child,
      .sub-simu-table th:first-child, .sub-simu-table td:first-child {
        width: 39vw;
        min-width: 110px;
      }
      .anisometropie-block { padding: 1em 0.4em; }
      .slider-wrap { width: 90px; min-width: 90px; }
    }
  </style>
</head>
<body>
  <h1>Simulation Chirurgie Réfractive</h1>
  <div class="container">

    <!-- Données patients -->
    <div class="section">
      <div class="section-title">Données patients</div>
      <table class="main-table">
        <tr>
          <th></th>
          <th>OD</th>
          <th>OG</th>
        </tr>
        <tr>
          <td>Sphère</td>
          <td>
            <input id="od-sphere" type="number" step="0.25" class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-sphere" type="number" step="0.25" class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>Cylindre</td>
          <td>
            <input id="od-cylinder" type="number" step="0.25" class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-cylinder" type="number" step="0.25" class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>Équivalent sphérique</td>
          <td>
            <input id="od-equiv" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-equiv" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>Pachymétrie (µm)</td>
          <td>
            <input id="od-pachy" type="number" class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-pachy" type="number" class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>Kmin (D)</td>
          <td>
            <input id="od-kmin" type="number" step="0.01" class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-kmin" type="number" step="0.01" class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>Kmax (D)</td>
          <td>
            <input id="od-kmax" type="number" step="0.01" class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-kmax" type="number" step="0.01" class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>Pupillométrie (mm)</td>
          <td>
            <input id="od-pupille" type="number" step="0.1" class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-pupille" type="number" step="0.1" class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
      </table>
    </div>

    <!-- Données chirurgicales -->
    <div class="section">
      <div class="section-title">Données chirurgicales</div>
      <table class="main-table">
        <tr>
          <th></th>
          <th>OD</th>
          <th>OG</th>
        </tr>
        <tr>
          <td>Zone optique (mm)</td>
          <td>
            <div class="slider-wrap">
              <input id="od-zone" type="range" min="60" max="85" step="5" value="65">
              <span id="od-zone-label">6.5</span>
            </div>
          </td>
          <td>
            <div class="slider-wrap">
              <input id="og-zone" type="range" min="60" max="85" step="5" value="65">
              <span id="og-zone-label">6.5</span>
            </div>
          </td>
        </tr>
        <tr>
          <td>Capot (µm)</td>
          <td>
            <div class="slider-wrap">
              <input id="od-capot" type="range" min="0" max="2" step="1" value="2">
              <span id="od-capot-label">110</span>
            </div>
          </td>
          <td>
            <div class="slider-wrap">
              <input id="og-capot" type="range" min="0" max="2" step="1" value="2">
              <span id="og-capot-label">110</span>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <!-- Simulation -->
    <div class="section">
      <div class="section-title">Simulation</div>
      <table class="main-table">
        <tr>
          <th></th>
          <th>OD</th>
          <th>OG</th>
        </tr>
        <tr>
          <td>Ablation centrale (µm)</td>
          <td>
            <input id="od-ablation" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-ablation" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td>K post-op (D)</td>
          <td>
            <input id="od-kpost" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-kpost" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td style="background: #f5f8fd; font-weight: 600; color: var(--blue-accent); border-top: 2px solid #e2e9f0;" colspan="3">LASIK / PKR</td>
        </tr>
        <tr>
          <td></td>
          <th>LASIK</th>
          <th>PKR</th>
        </tr>
        <tr>
          <td>Mur (µm)</td>
          <td>
            <input id="od-mur-lasik" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="od-mur-pkr" type="text" readonly class="colored-empty">
            <span class="icon"></span>
            <span class="pkr-warning" id="od-pkr-warning"></span>
          </td>
        </tr>
        <tr>
          <td>PTA (%)</td>
          <td>
            <input id="od-pta-lasik" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="od-pta-pkr" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
        <tr>
          <td></td>
          <th>LASIK</th>
          <th>PKR</th>
        </tr>
        <tr>
          <td>Mur (µm)</td>
          <td>
            <input id="og-mur-lasik" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-mur-pkr" type="text" readonly class="colored-empty">
            <span class="icon"></span>
            <span class="pkr-warning" id="og-pkr-warning"></span>
          </td>
        </tr>
        <tr>
          <td>PTA (%)</td>
          <td>
            <input id="og-pta-lasik" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
          <td>
            <input id="og-pta-pkr" type="text" readonly class="colored-empty">
            <span class="icon"></span>
          </td>
        </tr>
      </table>
    </div>

    <!-- Anisométropie -->
    <div class="anisometropie-block">
      <span class="anisometropie-label">Différence équivalent sphérique OD/OG :</span>
      <span>
        <input id="anisometropie" type="text" readonly class="colored-empty anisometropie-input">
        <span class="icon"></span>
      </span>
    </div>
    <div class="buttons">
      <button type="button" onclick="resetFields()">Réinitialiser</button>
    </div>
  </div>

  <script>
    // COULEURS
    const GREEN = "colored-green";
    const ORANGE = "colored-orange";
    const RED = "colored-red";
    const EMPTY = "colored-empty";

    function setBorderClass(input, c) {
      input.classList.remove(GREEN, ORANGE, RED, EMPTY);
      input.classList.add(c);
    }
    function getFloat(el) {
      if (!el) return NaN;
      let v = el.value.replace(",", ".");
      return parseFloat(v);
    }
    function getCentralAblation(sphere, cylinder) {
      const table = {
        "-1|0":22,"-2|0":38,"-3|0":54,"-4|0":70,"-5|0":86,"-6|0":101,"-7|0":117,"-8|0":133,"-9|0":148,"-10|0":164,
        "-1|-1":36,"-2|-1":52,"-3|-1":68,"-4|-1":84,"-5|-1":100,"-6|-1":116,"-7|-1":132,"-8|-1":148,"-9|-1":164,"-10|-1":180,
        "-1|-2":50,"-2|-2":66,"-3|-2":82,"-4|-2":98,"-5|-2":114,"-6|-2":130,"-7|-2":146,"-8|-2":162,"-9|-2":178,"-10|-2":194
      };
      const key = `${-Math.abs(Math.round(sphere))}|${Math.round(cylinder)}`;
      return table[key] ?? Math.round(20 + 16*Math.abs(sphere) + 8*Math.abs(cylinder));
    }
    function colorField(input, val, conds) {
      const cls = isNaN(val)||val==="" ? EMPTY
                : conds.red(val)   ? RED
                : conds.orange && conds.orange(val) ? ORANGE
                : GREEN;
      setBorderClass(input, cls);
      // icône
      const icon = input.nextElementSibling;
      if (icon) icon.textContent = cls===GREEN ? "✓"
                                : cls===ORANGE? "•"
                                : cls===RED   ? "✕"
                                : "";
    }
    function fieldThresholds(id) {
      if (id.includes("pachy"))  return {red:x=>x<470||x>700, orange:x=>x<500||x>650};
      if (id.includes("kmin"))   return {red:x=>x<39||x>49,  orange:x=>x<41||x>47};
      if (id.includes("kmax"))   return {red:x=>x<40||x>56,  orange:x=>x<43||x>54};
      if (id.includes("pupille"))return {red:x=>x>7,        orange:x=>x>6};
      if (id.includes("equiv"))  return {red:x=>x>5||x<-10, orange:x=>x>3||x<-7};
      if (id.includes("ablation"))return{red:x=>x>140,      orange:x=>x>120};
      if (id.includes("mur-lasik"))return{red:x=>x<280,     orange:x=>x<320};
      if (id.includes("pta-lasik"))return{red:x=>x>40,      orange:x=>x>38};
      if (id.includes("mur-pkr")) return {red:x=>x<320,     orange:x=>x<350};
      if (id.includes("pta-pkr")) return {red:x=>x>38,      orange:x=>x>36};
      if (id.includes("kpost"))   return {red:x=>x<34||x>50, orange:x=>x<36||x>48};
      if (id.includes("sphere"))  return {red:x=>x>5||x<-10, orange:x=>x>3||x<-7};
      if (id.includes("cylinder"))return {red:x=>x<-6||x>0, orange:x=>x<-4};
      return {red:x=>false, orange:x=>false};
    }

    // Affichage du warning PKR selon critères
    function updatePKRWarning(eye) {
      const abl = getFloat(document.getElementById(`${eye}-ablation`));
      const sph = getFloat(document.getElementById(`${eye}-sphere`));
      const equiv = getFloat(document.getElementById(`${eye}-equiv`));
      let show = false, warning = '';
      // Si ablation ≥75 ou sphère/équivalent ≤ -3
      if ((abl >= 75) || (sph <= -3) || (equiv <= -3)) {
        warning = "Mito recommandée";
        show = true;
      } else if (abl !== "" && abl < 75 && sph > -3 && equiv > -3) {
        warning = "sans Mito";
        show = true;
      }
      const warnEl = document.getElementById(`${eye}-pkr-warning`);
      warnEl.textContent = show ? warning : '';
      warnEl.style.color = warning === "Mito recommandée" ? "#ff3558" : "#29d658";
    }

    function updateFields(eye) {
      const sphereEl   = document.getElementById(`${eye}-sphere`);
      const cylinderEl = document.getElementById(`${eye}-cylinder`);
      const equivEl    = document.getElementById(`${eye}-equiv`);
      const pachyEl    = document.getElementById(`${eye}-pachy`);
      const kminEl     = document.getElementById(`${eye}-kmin`);
      const kmaxEl     = document.getElementById(`${eye}-kmax`);
      const pupilleEl  = document.getElementById(`${eye}-pupille`);
      const zoneEl     = document.getElementById(`${eye}-zone`);
      const capotEl    = document.getElementById(`${eye}-capot`);
      const abEl       = document.getElementById(`${eye}-ablation`);
      const kpostEl    = document.getElementById(`${eye}-kpost`);
      const mlEl       = document.getElementById(`${eye}-mur-lasik`);
      const ptaLEl     = document.getElementById(`${eye}-pta-lasik`);
      const mpEl       = document.getElementById(`${eye}-mur-pkr`);
      const ptaPEl     = document.getElementById(`${eye}-pta-pkr`);

      const s = getFloat(sphereEl), c = getFloat(cylinderEl);
      // équivalent
      let eq = ""; if (!isNaN(s)&&!isNaN(c)) eq = (s + c/2).toFixed(2);
      equivEl.value = eq;
      // sliders labels
      document.getElementById(`${eye}-zone-label`).textContent   = (zoneEl.value/10).toFixed(1);
      const capVal = 90 + parseInt(capotEl.value)*10;
      document.getElementById(`${eye}-capot-label`).textContent = capVal;

      // ablation
      let abl=""; if(!isNaN(s)&&!isNaN(c)) abl=getCentralAblation(s,c);
      abEl.value = abl;

      // k post
      const kmin = getFloat(kminEl);
      let kp=""; if(!isNaN(kmin)&&!isNaN(s)) kp=(kmin+s).toFixed(2);
      kpostEl.value = kp;

      // mur & pta LASIK/PKR
      const pachy = getFloat(pachyEl);
      if(!isNaN(pachy)&&abl!=="") {
        const ml = pachy - capVal - abl;
        mlEl.value = Math.round(ml);
        ptaLEl.value = ((pachy-ml)/pachy*100).toFixed(1);
        const mp = pachy - 54 - abl;
        mpEl.value = Math.round(mp);
        ptaPEl.value = ((pachy-mp)/pachy*100).toFixed(1);
      }

      // code couleur + icônes
      [
        [sphereEl, s],[cylinderEl, c],[equivEl, eq],[pachyEl, pachy],
        [kminEl, kmin],[kmaxEl, getFloat(kmaxEl)],[pupilleEl, getFloat(pupilleEl)],
        [abEl, abl],[kpostEl, kp],[mlEl, getFloat(mlEl)],[ptaLEl, getFloat(ptaLEl)],
        [mpEl, getFloat(mpEl)],[ptaPEl, getFloat(ptaPEl)]
      ].forEach(([el,val]) => colorField(el,val,fieldThresholds(el.id)));

      // Affichage warning PKR/mito
      updatePKRWarning(eye);
    }

    function updateAll() {
      ["od","og"].forEach(updateFields);
      const oEq = getFloat(document.getElementById("od-equiv"));
      const gEq = getFloat(document.getElementById("og-equiv"));
      const anis = document.getElementById("anisometropie");
      anis.value = (!isNaN(oEq)&&!isNaN(gEq)) ? Math.abs(oEq-gEq).toFixed(2) : "";
      colorField(anis, anis.value, fieldThresholds("anisometropie"));
    }

    function resetFields() {
      document.querySelectorAll("input[type=number], input[type=text]").forEach(i => i.value = "");
      ["od","og"].forEach(e=>{
        document.getElementById(e+"-zone").value = 65;
        document.getElementById(e+"-capot").value = 2;
      });
      updateAll();
    }

    // Listeners
    window.onload = () => {
      document.querySelectorAll("input, .slider-wrap input[type=range]").forEach(i=>{
        i.addEventListener("input", updateAll);
      });
      resetFields();
    };
  </script>
</body>
</html>

