<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulation Chirurgie Réfractive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f9fbfd;
      --card: #ffffff;
      --text: #1c1c1c;
      --label: #4a707a;
      --border: #ccd6dd;
      --focus: #9ec8e9;
      --green: #29d658;
      --orange: #ffb400;
      --red: #e63946;
      --accent: #a5c8ee;
      --radius: 12px;
      --icon-size: 1rem;
    }
    body {
      margin: 0; font-family: sans-serif;
      background: var(--bg); color: var(--text);
      font-size: 16px;
    }
    h1 {
      text-align: center;
      font-size: 1.8em;
      color: var(--label);
      margin: 1em 0 0.5em;
    }
    .wrapper {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1em;
    }
    .section {
      background: var(--card);
      padding: 1em;
      margin-bottom: 1em;
      border-radius: var(--radius);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .section h2 {
      margin: 0 0 0.5em;
      font-size: 1.3em;
      color: var(--accent);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 0.5em;
      vertical-align: top;
    }
    th {
      color: var(--label);
      font-weight: 600;
      white-space: nowrap;
    }
    td input {
      width: 100%;
      padding: 0.3em 0.4em;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 1em;
    }
    td input:focus {
      border-color: var(--focus);
      outline: none;
    }
    .green { border-color: var(--green) !important; }
    .orange { border-color: var(--orange) !important; }
    .red { border-color: var(--red) !important; }
    .note {
      font-size: 0.9em;
      color: var(--label);
      margin-top: 0.3em;
    }
    .center {
      text-align: center;
    }
    .wide {
      width: 100%;
      max-width: 400px;
      margin: 1em auto;
      text-align: center;
    }
    .wide input {
      text-align: center;
      font-size: 1.2em;
      width: 100px;
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6em 1.5em;
      border-radius: var(--radius);
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background: #4f83c4;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      tr {
        margin-bottom: 1em;
      }
      td {
        padding-left: 50%;
        position: relative;
      }
      td::before {
        position: absolute;
        top: 0;
        left: 0;
        width: 45%;
        padding-left: 0.5em;
        white-space: nowrap;
        font-weight: bold;
        color: var(--label);
      }
    }
  </style>
</head>
<body>
  <h1>Simulation Chirurgie Réfractive</h1>
  <div class="wrapper">
    <!-- Sections HTML conservées ici -->
  </div>
  <script>
    const seuils = {
      "pachy": { red: x => x < 470 || x > 700, orange: x => x < 500 || x > 650 },
      "kmin": { red: x => x < 39 || x > 49, orange: x => x < 41 || x > 47 },
      "kmax": { red: x => x < 40 || x > 56, orange: x => x < 43 || x > 54 },
      "pupille": { red: x => x > 7, orange: x => x > 6 },
      "equiv": { red: x => x > 5 || x < -10, orange: x => x > 3 || x < -7 },
      "ablation": { red: x => x > 140, orange: x => x > 120 },
      "mur-lasik": { red: x => x < 280, orange: x => x < 320 },
      "pta-lasik": { red: x => x > 40, orange: x => x > 38 },
      "mur-pkr": { red: x => x < 320, orange: x => x < 350 },
      "pta-pkr": { red: x => x > 38, orange: x => x > 36 },
      "kpost": { red: x => x < 34 || x > 50, orange: x => x < 36 || x > 48 },
      "sphere": { red: x => x > 5 || x < -10, orange: x => x > 3 || x < -7 },
      "cylinder": { red: x => x < -6 || x > 0, orange: x => x < -4 }
    };

    function getFloat(id) {
      const el = document.getElementById(id);
      return el && el.value ? parseFloat(el.value.replace(",", ".")) : NaN;
    }

    function updateMito(eye, abl, sph, equiv) {
      const msg = (abl >= 75 || sph < -3 || equiv < -3) ? "Mito recommandée" : "sans Mito";
      document.getElementById(`${eye}-mito`).textContent = msg;
    }

    function updateZoneLabel(eye) {
      const zone = document.getElementById(`${eye}-zone`);
      document.getElementById(`${eye}-zone-label`).textContent = (zone.value / 10).toFixed(1);
    }

    function updateCapotLabel(eye) {
      const capot = document.getElementById(`${eye}-capot`);
      document.getElementById(`${eye}-capot-label`).textContent = (90 + parseInt(capot.value) * 10).toString();
    }

    function colorInput(id, val) {
      const el = document.getElementById(id);
      const key = Object.keys(seuils).find(k => id.includes(k));
      if (!key) return;
      el.classList.remove("green", "orange", "red");
      if (isNaN(val)) return;
      const rule = seuils[key];
      if (rule.red(val)) el.classList.add("red");
      else if (rule.orange && rule.orange(val)) el.classList.add("orange");
      else el.classList.add("green");
    }

    function calculate(eye) {
      const s = getFloat(`${eye}-sphere`);
      const c = getFloat(`${eye}-cylinder`);
      const p = getFloat(`${eye}-pachy`);
      const km = getFloat(`${eye}-kmin`);
      const capRaw = parseInt(document.getElementById(`${eye}-capot`).value);
      const cap = 90 + capRaw * 10;

      const eq = (!isNaN(s) && !isNaN(c)) ? s + c/2 : NaN;
      const abl = (!isNaN(s) && !isNaN(c)) ? Math.round(20 + 16 * Math.abs(s) + 8 * Math.abs(c)) : NaN;
      const kpost = (!isNaN(km) && !isNaN(s)) ? (km + s).toFixed(2) : "";
      const ml = (!isNaN(p) && !isNaN(abl)) ? Math.round(p - cap - abl) : "";
      const pl = (!isNaN(p) && !isNaN(ml)) ? ((p - ml) / p * 100).toFixed(1) : "";
      const mp = (!isNaN(p) && !isNaN(abl)) ? Math.round(p - 54 - abl) : "";
      const pp = (!isNaN(p) && !isNaN(mp)) ? ((p - mp) / p * 100).toFixed(1) : "";

      document.getElementById(`${eye}-equiv`).value = isNaN(eq) ? "" : eq.toFixed(2);
      document.getElementById(`${eye}-ablation`).value = isNaN(abl) ? "" : abl;
      document.getElementById(`${eye}-kpost`).value = kpost;
      document.getElementById(`${eye}-mur-lasik`).value = ml;
      document.getElementById(`${eye}-pta-lasik`).value = pl;
      document.getElementById(`${eye}-mur-pkr`).value = mp;
      document.getElementById(`${eye}-pta-pkr`).value = pp;

      colorInput(`${eye}-equiv`, eq);
      colorInput(`${eye}-ablation`, abl);
      colorInput(`${eye}-kpost`, parseFloat(kpost));
      colorInput(`${eye}-mur-lasik`, parseFloat(ml));
      colorInput(`${eye}-pta-lasik`, parseFloat(pl));
      colorInput(`${eye}-mur-pkr`, parseFloat(mp));
      colorInput(`${eye}-pta-pkr`, parseFloat(pp));

      updateMito(eye, abl, s, eq);
    }

    function updateAll() {
      ["od", "og"].forEach(eye => {
        ["sphere", "cylinder", "pachy", "kmin", "kmax", "pupille"].forEach(id => {
          const val = getFloat(`${eye}-${id}`);
          colorInput(`${eye}-${id}`, val);
        });
        updateZoneLabel(eye);
        updateCapotLabel(eye);
        calculate(eye);
      });
      const odEq = getFloat("od-equiv"), ogEq = getFloat("og-equiv");
      const diff = (!isNaN(odEq) && !isNaN(ogEq)) ? Math.abs(odEq - ogEq).toFixed(2) : "";
      document.getElementById("anisometropie").value = diff;
    }

    function resetFields() {
      document.querySelectorAll("input[type=number], input[type=text]").forEach(i => i.value = "");
      ["od", "og"].forEach(e => {
        document.getElementById(`${e}-zone`).value = 65;
        document.getElementById(`${e}-capot`).value = 2;
        updateZoneLabel(e);
        updateCapotLabel(e);
      });
      updateAll();
    }

    window.onload = () => {
      document.querySelectorAll("input").forEach(i => i.addEventListener("input", updateAll));
      resetFields();
    }
  </script>
</body>
</html>
