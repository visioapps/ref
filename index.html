<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulation Chirurgie Réfractive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --background: #f7faff;
      --card-bg: #fafdff;
      --text: #111a23;
      --label: #4A707A;
      --input-bg: #fff;
      --input-border: #c2ced9;
      --input-focus: #9ec8e9;
      --input-readonly: #f4f7fb;
      --green: #29d658;
      --orange: #ffd700;
      --red: #ff3558;
      --blue-accent: #a5c8ee;
      --card-shadow: 0 2px 16px rgba(70, 90, 120, 0.06);
      --radius: 16px;
      --main-width: 850px;
      --spacing: 1.5rem;
      --input-width: 120px;
      --label-width: 175px;
    }
    html, body {
      background: var(--background); margin: 0; padding: 0;
      font-family: 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
      color: var(--text); font-size: 18px;
    }
    h1 {
      text-align: center; color: var(--label);
      font-size: 2.2rem; font-weight: 700;
      margin-top: 2rem; margin-bottom: 2rem;
      letter-spacing: 0.04em;
    }
    .container {
      max-width: var(--main-width); margin: 0 auto;
      background: var(--card-bg); border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      padding: 2.3rem 2rem 2rem 2rem;
      margin-bottom: 2rem;
      box-sizing: border-box;
      overflow-x: auto;
    }
    .eye-blocks {
      display: flex; gap: 2rem;
      justify-content: space-between; flex-wrap: wrap;
    }
    @media (max-width: 900px) { .eye-blocks { flex-direction: column; gap: 1.2rem; } }
    .eye-panel {
      flex: 1 1 350px;
      min-width: 320px; max-width: 400px;
      background: var(--card-bg);
      border-radius: var(--radius); padding: 1.3rem 1.1rem 1.1rem 1.1rem;
      box-shadow: 0 1px 8px rgba(70, 90, 120, 0.03);
      border: 1.5px solid #eef2f6;
      margin-bottom: 1.2rem;
      box-sizing: border-box;
      overflow-x: auto;
    }
    .eye-title {
      font-size: 1.23rem;
      font-weight: 600; color: var(--blue-accent);
      margin-bottom: 0.4rem; letter-spacing: 0.03em;
      text-align: left;
    }
    form { width: 100%; }
    .form-row {
      display: flex; align-items: center;
      justify-content: flex-start;
      margin: 0.6em 0;
      gap: 1.1rem;
      width: 100%;
    }
    .form-row label {
      flex: 0 0 var(--label-width);
      min-width: var(--label-width);
      text-align: left;
      color: var(--label);
      font-weight: 500;
      font-size: 1.04rem;
      margin-right: 0.3rem;
      white-space: nowrap;
    }
    .form-row input[type="number"],
    .form-row input[type="text"] {
      flex: 0 1 var(--input-width);
      max-width: var(--input-width);
      min-width: 70px;
      background: var(--input-bg);
      color: var(--text);
      border: 2.5px solid var(--input-border);
      border-radius: 8px;
      font-size: 1.07em;
      padding: 7px 9px;
      outline: none; transition: border .2s, box-shadow .2s;
      box-shadow: none;
      box-sizing: border-box;
    }
    .form-row input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px #dbefff8c;
    }
    .form-row input[readonly] {
      background: var(--input-readonly);
      color: #8fa5b3;
    }
    /* CODE COULEUR: contours uniquement */
    .form-row input.colored-green { border-color: var(--green) !important; background: var(--input-bg);}
    .form-row input.colored-orange { border-color: var(--orange) !important; background: var(--input-bg);}
    .form-row input.colored-red { border-color: var(--red) !important; background: var(--input-bg);}
    .form-row input.colored-empty { border-color: var(--input-border);}
    .form-row input:disabled { background: #ececec; }

    .form-row .slider-wrap { display: flex; align-items: center; gap: 0.7em; flex: 1;}
    .form-row input[type="range"] { flex: 1; accent-color: var(--blue-accent); }
    .radio-row {
      display: flex; align-items: center; gap: 1.3em; margin-bottom: .1em; margin-top: .3em;
    }
    .radio-row label { margin: 0 1.2em 0 0; color: var(--label); font-weight: 400; font-size: 1.01rem;}
    .anisometropie-block {
      margin: 1.2rem auto 0 auto;
      background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--card-shadow);
      padding: 1.1rem 2rem 1rem 2rem;
      max-width: 450px; min-width: 220px;
      border: 1.5px solid #eef2f6;
      display: flex; flex-direction: column; align-items: center;
    }
    .anisometropie-block label { font-weight: 500; color: var(--label); margin-bottom: .5em;}
    .anisometropie-block input { width: 90px; text-align: center;}
    .buttons { text-align: center; margin: 2.1rem 0 0 0; }
    button {
      background: var(--blue-accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 30px;
      font-size: 1.12rem;
      font-weight: 600;
      cursor: pointer;
      margin: 0 1em;
      box-shadow: 0 2px 14px rgba(100, 140, 190, 0.08);
      transition: background 0.18s;
      letter-spacing: 0.02em;
    }
    button:hover {
      background: #4674a8;
    }
    @media (max-width: 600px) {
      .container { padding: 1.2rem 0.3rem; }
      .eye-panel { min-width: 95vw; }
      .anisometropie-block { padding: .7rem 0.7rem; }
      .form-row label { min-width: 95px; }
    }
  </style>
</head>
<body>
  <h1>Simulation Chirurgie Réfractive</h1>
  <div class="container">
    <div class="eye-blocks">
      <!-- OD -->
      <div class="eye-panel" id="od-panel">
        <div class="eye-title">Oeil Droit (OD)</div>
        <form>
          <div class="form-row"><label>Sphère</label> <input id="od-sphere" type="number" step="0.25"></div>
          <div class="form-row"><label>Cylindre</label> <input id="od-cylinder" type="number" step="0.25"></div>
          <div class="form-row"><label>Équivalent sphérique</label> <input id="od-equiv" type="text" readonly></div>
          <div class="form-row"><label>Pachymétrie (µm)</label> <input id="od-pachy" type="number"></div>
          <div class="form-row"><label>Kmin</label> <input id="od-kmin" type="number" step="0.01"></div>
          <div class="form-row"><label>Kmax</label> <input id="od-kmax" type="number" step="0.01"></div>
          <div class="form-row"><label>Pupillométrie</label> <input id="od-pupille" type="number" step="0.1"></div>
          <div class="form-row radio-row">
            <label><input type="radio" name="od-tech" value="lasik" checked> Lasik</label>
            <label><input type="radio" name="od-tech" value="pkr"> PKR</label>
            <label><input type="radio" name="od-tech" value="mito"> PKR mito</label>
          </div>
          <div class="form-row">
            <label>Zone optique (mm)</label>
            <div class="slider-wrap">
              <input id="od-zone" type="range" min="60" max="85" step="5" value="65">
              <span id="od-zone-label">6.5</span>
            </div>
          </div>
          <div class="form-row">
            <label>Capot (µm)</label>
            <div class="slider-wrap">
              <input id="od-capot" type="range" min="0" max="2" step="1" value="2">
              <span id="od-capot-label">110</span>
            </div>
          </div>
          <div class="form-row"><label>Ablation centrale (µm)</label> <input id="od-ablation" type="text" readonly></div>
          <div class="form-row"><label>K post-op (D)</label> <input id="od-kpost" type="text" readonly></div>
          <div class="form-row"><label>Mur LASIK (µm)</label> <input id="od-mur-lasik" type="text" readonly></div>
          <div class="form-row"><label>PTA LASIK (%)</label> <input id="od-pta-lasik" type="text" readonly></div>
          <div class="form-row"><label>Mur PKR (µm)</label> <input id="od-mur-pkr" type="text" readonly></div>
          <div class="form-row"><label>PTA PKR (%)</label> <input id="od-pta-pkr" type="text" readonly></div>
        </form>
      </div>
      <!-- OG -->
      <div class="eye-panel" id="og-panel">
        <div class="eye-title">Oeil Gauche (OG)</div>
        <form>
          <div class="form-row"><label>Sphère</label> <input id="og-sphere" type="number" step="0.25"></div>
          <div class="form-row"><label>Cylindre</label> <input id="og-cylinder" type="number" step="0.25"></div>
          <div class="form-row"><label>Équivalent sphérique</label> <input id="og-equiv" type="text" readonly></div>
          <div class="form-row"><label>Pachymétrie (µm)</label> <input id="og-pachy" type="number"></div>
          <div class="form-row"><label>Kmin</label> <input id="og-kmin" type="number" step="0.01"></div>
          <div class="form-row"><label>Kmax</label> <input id="og-kmax" type="number" step="0.01"></div>
          <div class="form-row"><label>Pupillométrie</label> <input id="og-pupille" type="number" step="0.1"></div>
          <div class="form-row radio-row">
            <label><input type="radio" name="og-tech" value="lasik" checked> Lasik</label>
            <label><input type="radio" name="og-tech" value="pkr"> PKR</label>
            <label><input type="radio" name="og-tech" value="mito"> PKR mito</label>
          </div>
          <div class="form-row">
            <label>Zone optique (mm)</label>
            <div class="slider-wrap">
              <input id="og-zone" type="range" min="60" max="85" step="5" value="65">
              <span id="og-zone-label">6.5</span>
            </div>
          </div>
          <div class="form-row">
            <label>Capot (µm)</label>
            <div class="slider-wrap">
              <input id="og-capot" type="range" min="0" max="2" step="1" value="2">
              <span id="og-capot-label">110</span>
            </div>
          </div>
          <div class="form-row"><label>Ablation centrale (µm)</label> <input id="og-ablation" type="text" readonly></div>
          <div class="form-row"><label>K post-op (D)</label> <input id="og-kpost" type="text" readonly></div>
          <div class="form-row"><label>Mur LASIK (µm)</label> <input id="og-mur-lasik" type="text" readonly></div>
          <div class="form-row"><label>PTA LASIK (%)</label> <input id="og-pta-lasik" type="text" readonly></div>
          <div class="form-row"><label>Mur PKR (µm)</label> <input id="og-mur-pkr" type="text" readonly></div>
          <div class="form-row"><label>PTA PKR (%)</label> <input id="og-pta-pkr" type="text" readonly></div>
        </form>
      </div>
    </div>
    <!-- Anisométropie -->
    <div class="anisometropie-block">
      <label>Différence équivalent sphérique OD/OG :</label>
      <input id="anisometropie" type="text" readonly>
    </div>
    <div class="buttons">
      <button onclick="resetFields()">Réinitialiser</button>
    </div>
  </div>
  <script>
    // --- Couleurs
    const GREEN = "colored-green";
    const ORANGE = "colored-orange";
    const RED = "colored-red";
    const EMPTY = "colored-empty";

    function setBorderClass(input, c) {
      input.classList.remove(GREEN, ORANGE, RED, EMPTY);
      input.classList.add(c);
    }

    function getFloat(el) {
      if(!el) return NaN;
      let v = el.value.replace(",", "."); // autorise virgule
      return parseFloat(v);
    }

    // Table simplifiée d’ablation
    function getCentralAblation(sphere, cylinder) {
      let table = {
        "-1|0": 22, "-2|0": 38, "-3|0": 54, "-4|0": 70, "-5|0": 86, "-6|0": 101, "-7|0": 117, "-8|0": 133, "-9|0": 148, "-10|0": 164,
        "-1|-1": 36, "-2|-1": 52, "-3|-1": 68, "-4|-1": 84, "-5|-1": 100, "-6|-1": 116, "-7|-1": 132, "-8|-1": 148, "-9|-1": 164, "-10|-1": 180,
        "-1|-2": 50, "-2|-2": 66, "-3|-2": 82, "-4|-2": 98, "-5|-2": 114, "-6|-2": 130, "-7|-2": 146, "-8|-2": 162, "-9|-2": 178, "-10|-2": 194,
      };
      let s = -Math.abs(Math.round(sphere));
      let c = Math.round(cylinder);
      let key = `${s}|${c}`;
      if(table[key] !== undefined) return table[key];
      return Math.round(20 + 16 * Math.abs(sphere) + 8 * Math.abs(cylinder));
    }

    function colorField(input, val, conds) {
      if (val === "" || isNaN(val)) setBorderClass(input, EMPTY);
      else if (conds.red(val)) setBorderClass(input, RED);
      else if (conds.orange && conds.orange(val)) setBorderClass(input, ORANGE);
      else setBorderClass(input, GREEN);
    }

    // Seuils cliniques pour chaque champ (exemples courants, à adapter à ta pratique)
    function fieldThresholds(id) {
      if (id.includes("pachy"))       return {red:x=>x<470||x>700, orange:x=>x<500||x>650}; // µm
      if (id.includes("kmin"))        return {red:x=>x<39||x>49, orange:x=>x<41||x>47};     // D
      if (id.includes("kmax"))        return {red:x=>x<40||x>56, orange:x=>x<43||x>54};     // D
      if (id.includes("pupille"))     return {red:x=>x>7, orange:x=>x>6};                   // mm
      if (id.includes("equiv"))       return {red:x=>x>5||x<-10, orange:x=>x>3||x<-7};      // D
      if (id.includes("ablation"))    return {red:x=>x>140, orange:x=>x>120};               // µm
      if (id.includes("mur-lasik"))   return {red:x=>x<280, orange:x=>x<320};               // µm
      if (id.includes("pta-lasik"))   return {red:x=>x>40, orange:x=>x>38};                 // %
      if (id.includes("mur-pkr"))     return {red:x=>x<320, orange:x=>x<350};               // µm
      if (id.includes("pta-pkr"))     return {red:x=>x>38, orange:x=>x>36};                 // %
      if (id.includes("kpost"))       return {red:x=>x<34||x>50, orange:x=>x<36||x>48};     // D
      if (id.includes("sphere"))      return {red:x=>x>5||x<-10, orange:x=>x>3||x<-7};
      if (id.includes("cylinder"))    return {red:x=>x<-6||x>0, orange:x=>x<-4};
      return {red:x=>false, orange:x=>false};
    }

    function updateFields(eye) {
      let sphereEl   = document.getElementById(eye + "-sphere");
      let cylinderEl = document.getElementById(eye + "-cylinder");
      let equivEl    = document.getElementById(eye + "-equiv");
      let pachyEl    = document.getElementById(eye + "-pachy");
      let kminEl     = document.getElementById(eye + "-kmin");
      let kmaxEl     = document.getElementById(eye + "-kmax");
      let pupilleEl  = document.getElementById(eye + "-pupille");
      let kpostEl    = document.getElementById(eye + "-kpost");
      let ablationEl = document.getElementById(eye + "-ablation");
      let zoneSlider = document.getElementById(eye + "-zone");
      let capotSlider= document.getElementById(eye + "-capot");
      let murLasikEl = document.getElementById(eye + "-mur-lasik");
      let ptaLasikEl = document.getElementById(eye + "-pta-lasik");
      let murPkrEl   = document.getElementById(eye + "-mur-pkr");
      let ptaPkrEl   = document.getElementById(eye + "-pta-pkr");

      let sphere   = getFloat(sphereEl);
      let cylinder = getFloat(cylinderEl);
      let pachy    = getFloat(pachyEl);
      let kmin     = getFloat(kminEl);
      let kmax     = getFloat(kmaxEl);
      let pupille  = getFloat(pupilleEl);

      // Sliders labels
      document.getElementById(eye + "-zone-label").textContent = (zoneSlider.value / 10).toFixed(1);
      document.getElementById(eye + "-capot-label").textContent = (90 + parseInt(capotSlider.value) * 10).toString();

      // Equiv sphérique
      let equiv = "";
      if(!isNaN(sphere) && !isNaN(cylinder)) {
        equiv = sphere + cylinder/2;
        equivEl.value = equiv.toFixed(2);
      } else { equivEl.value = ""; }

      // Ablation centrale
      let ablationVal = "";
      if(!isNaN(sphere) && !isNaN(cylinder)) {
        ablationVal = getCentralAblation(sphere, cylinder);
        ablationEl.value = ablationVal;
      } else ablationEl.value = "";

      // K post-op (simplifié)
      let kpost = "";
      if(!isNaN(kmin) && !isNaN(sphere)) {
        kpost = kmin + sphere;
        kpostEl.value = kpost.toFixed(2);
      } else { kpostEl.value = ""; }

      // LASIK
      let capotVal = 90 + parseInt(capotSlider.value)*10;
      let murLasik = "", ptaLasik = "";
      if(!isNaN(pachy) && !isNaN(capotVal) && !isNaN(ablationVal)) {
        murLasik = pachy - capotVal - ablationVal;
        murLasikEl.value = Math.round(murLasik);
        ptaLasik = ((pachy - murLasik) / pachy) * 100;
        ptaLasikEl.value = ptaLasik.toFixed(1);
      } else {
        murLasikEl.value = ""; ptaLasikEl.value = "";
      }

      // PKR (capot=54)
      let murPkr = "", ptaPkr = "";
      if(!isNaN(pachy) && !isNaN(ablationVal)) {
        murPkr = pachy - 54 - ablationVal;
        murPkrEl.value = Math.round(murPkr);
        ptaPkr = ((pachy - murPkr) / pachy) * 100;
        ptaPkrEl.value = ptaPkr.toFixed(1);
      } else {
        murPkrEl.value = ""; ptaPkrEl.value = "";
      }

      // Code couleur pour TOUS les champs
      [
        [sphereEl, sphere], [cylinderEl, cylinder], [equivEl, equiv], [pachyEl, pachy],
        [kminEl, kmin], [kmaxEl, kmax], [pupilleEl, pupille], [ablationEl, ablationVal],
        [kpostEl, kpost], [murLasikEl, murLasik], [ptaLasikEl, ptaLasik],
        [murPkrEl, murPkr], [ptaPkrEl, ptaPkr]
      ].forEach(([el, val]) => {
        colorField(el, val, fieldThresholds(el.id));
      });
    }

    function updateAll() {
      updateFields("od"); updateFields("og");
      // Anisométropie
      let odEquiv = getFloat(document.getElementById("od-equiv"));
      let ogEquiv = getFloat(document.getElementById("og-equiv"));
      let anisEl = document.getElementById("anisometropie");
      if (!isNaN(odEquiv) && !isNaN(ogEquiv)) {
        anisEl.value = Math.abs(odEquiv - ogEquiv).toFixed(2);
      } else anisEl.value = "";
    }

    function resetFields() {
      document.querySelectorAll("input[type=number], input[type=text]").forEach(inp => inp.value = "");
      document.getElementById("od-zone").value = 65;
      document.getElementById("og-zone").value = 65;
      document.getElementById("od-zone-label").textContent = "6.5";
      document.getElementById("og-zone-label").textContent = "6.5";
      document.getElementById("od-capot").value = 2;
      document.getElementById("og-capot").value = 2;
      document.getElementById("od-capot-label").textContent = "110";
      document.getElementById("og-capot-label").textContent = "110";
      document.querySelectorAll('input[type=radio][value=lasik]').forEach(r=>r.checked=true);
      updateAll();
    }

    // Listeners
    ["od", "og"].forEach(eye => {
      ["sphere", "cylinder", "pachy", "kmin", "kmax", "pupille"].forEach(field => {
        document.getElementById(`${eye}-${field}`).addEventListener("input", updateAll);
      });
      document.getElementById(`${eye}-zone`).addEventListener("input", function() {
        document.getElementById(`${eye}-zone-label`).textContent = (this.value / 10).toFixed(1);
        updateAll();
      });
      document.getElementById(`${eye}-capot`).addEventListener("input", function() {
        document.getElementById(`${eye}-capot-label`).textContent = (90 + parseInt(this.value)*10).toString();
        updateAll();
      });
      document.querySelectorAll(`input[name="${eye}-tech"]`).forEach(radio => {
        radio.addEventListener("change", updateAll);
      });
    });

    window.onload = function() { resetFields(); };
  </script>
</body>
</html>
